
@{
    ViewBag.Title = "Ordini di Vendita";
    string currentUrl = HttpContext.Current.Request.Url.AbsoluteUri;
}
@section header {   
    <script>
        show_message = function (errore, messaggio) {
            alert(messaggio);
        }

        app.controller('ctrl', ['$scope', 'tabController', function ($scope, tabController) {

            @*@(ViewBag.scope_var)*@
            tabController.config({
                api_root: '@currentUrl',
                list_table: '#table',
                message_function: show_message
            });
            tabController.refresh();
            $scope.tc = tabController;
        }]);

    </script>
}
@section scripts{
    <script src="@Url.Content("~/Scripts/bootstrap-datepicker.min.js")"></script>
    <script src="@Url.Content("~/Scripts/bootstrap-datepicker.it.min.js")"></script>
    <script>
        $('.data-new input').datepicker({ format: "dd/mm/yyyy", weekStart: 1, language: "it", calendarWeeks: true });    

        $('#a-data').change(function () {
            var current = $('#a-data').val();
            var scope = angular.element($("[ng-controller='ctrl']")).scope();
            scope.$apply(function () {
                scope.tc.a_data = current;                
                scope.tc.refresh_page(scope.pag_corrente);
            });
        });

        $('#da-data').change(function () {
            var current = $('#da-data').val();
            var scope = angular.element($("[ng-controller='ctrl']")).scope();
            scope.$apply(function () {
                scope.tc.da_data = current;
                scope.tc.refresh_page(scope.pag_corrente);
            });
        });

        $.get('@(Url.Action("GetClienti", "Get"))', function (data) {
             $('#sel-cliente').typeahead({
                source: data
            });
        });

         $('#sel-cliente').change(function () {
             var current = $('#sel-cliente').typeahead("getActive");
             var scope = angular.element($("[ng-controller='ctrl']")).scope();
             scope.$apply(function () {
                 scope.tc.cliente = current;
                 scope.tc.id_cliente = current.id;
                 scope.tc.refresh_page(scope.pag_corrente);
             });
         });

         $.get('@(Url.Action("GetAgenti", "Get"))', function (data) {
             $('#sel-agente').typeahead({
                source: data
            });
        });

         $('#sel-agente').change(function () {
             var current = $('#sel-agente').typeahead("getActive");
             var scope = angular.element($("[ng-controller='ctrl']")).scope();
             scope.$apply(function () {
                 scope.tc.cliente = current;
                 scope.tc.id_cliente = current.id;
                 scope.tc.refresh_page(scope.pag_corrente);
             });
         });

        shortcut.add("Home", function () {
            $('#query').focus();
        });
        shortcut.add("Up", function () {
            var scope = angular.element($("[ng-controller='ctrl']")).scope();
            scope.$apply(function () {
                scope.tc.previous_record();
            });
        });
        shortcut.add("Down", function () {
            var scope = angular.element($("[ng-controller='ctrl']")).scope();
            scope.$apply(function () {
                scope.tc.next_record();
            });
        });
        shortcut.add("Ctrl+S", function () {
            var scope = angular.element($("[ng-controller='ctrl']")).scope();
            scope.$apply(function () {
                scope.tc.save_current_record();
            });
        });
        shortcut.add("pd", function () {
            var scope = angular.element($("[ng-controller='ctrl']")).scope();
            scope.$apply(function () {
                if (scope.tc.pag_corrente < scope.tc.pag_number - 1) {
                    scope.tc.refresh_page(scope.tc.pag_corrente + 1);
                }
            });
        });
        shortcut.add("pu", function () {
            var scope = angular.element($("[ng-controller='ctrl']")).scope();
            scope.$apply(function () {
                if (scope.tc.pag_corrente > 0) {
                    scope.tc.refresh_page(scope.tc.pag_corrente - 1);
                }
            });
        });
    </script>
}


<div class="header">
    <div class="col-md-12">
        <h3 class="header-title">@ViewBag.Title</h3>
        <p class="header-info">gestione ordini di vendita </p>

    </div>
</div>
<div class="main-content" ng-controller="ctrl">

    <div ng-show="tc.displayMode == 'list'">
        <!--Elenco inizio -->
        <div class="page-toolbar">
            <button class="btn btn-grey" ng-click="tc.refresh()"><i class="fa fa-refresh">&nbsp;</i>Refresh</button>
            <button class="btn btn-grey" ng-click="tc.editOrCreate()"><i class="fa fa-plus-square">&nbsp;</i>Nuovo</button>
        </div> <!-- page-toolbar -->
        <div class="margin-b-20"></div>

        <div class="panel panel-default">
            <div class="panel-heading">Filtri</div>
            <div class="panel-body">
                <div class="form-inline">

                    <div class="form-group">
                        <label>Agente</label>
                        <input type="text" class="form-control" placeholder="seleziona l'agente.." id="sel-agente" />
                    </div>
                    <div class="form-group">
                        <label>Cliente</label>
                        <input type="text" class="form-control" placeholder="seleziona il cliente.." id="sel-cliente" />
                    </div>
                    <div class="form-group data-new">
                        <label>da data</label>
                        <input type="text" class="form-control" id="da-data" />
                    </div>
                    <div class="form-group data-new">
                        <label>a data</label>
                        <input type="text" class="form-control" id="a-data" />
                    </div>
                    <div class="form-group">
                        <label>da ordine</label>
                        <input type="text" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label>a ordine</label>
                        <input type="text" class="form-control" />
                    </div>
                </div>
                <div class="margin-b-10"></div>
                <div>
                    <button type="submit" class="btn btn-default"><i class="fa fa-search"></i>&nbsp; Cerca</button>
                </div>


                @*<div class="input-group">
                        <input id="query" capitalize
                               type="text" class="form-control"
                               ng-model="filtri.id_cliente" placeholder="cerca..."
                               ng-on-enter="tc.refresh()" />
                        <span class="input-group-btn">
                            <button ng-click="tc.refresh()" type="button" class="btn btn-default"><i class="fa fa-search"></i></button>
                        </span>
                    </div>*@ <!--Fine -->

            </div>
        </div>

        <div class="row">

            <div class="col-md-12 col-lg-12">

                <h4><i class="fa fa-list-ul"></i> Elenco</h4>
                <tab-controller-pag table-controller="tc"></tab-controller-pag>
                <table class="table table-hover table-striped" id="table">
                    <thead>
                        <tr>
                            <th>Nr Ord.</th>
                            <th>Cliente</th>
                            <th>Data Ordine</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="item in tc.records">
                            <td>{{item.id_ordine | trimZeros}}</td>
                            <td>{{item.id_cliente | trimZeros}}</td>
                            <td>{{item.data_ordine | date: short}}</td>
                            <td>
                                <button class="btn btn-grey btn-xs" ng-click="tc.deleteItem(item)"><i class="glyphicon glyphicon-trash"></i></button>
                                <button class="btn btn-grey btn-xs" ng-click="tc.editOrCreate(item)"><i class="fa fa-pencil-square-o"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>

            </div> <!--Dettaglio-->
        </div>
    </div> <!--Fine Elenco-->


    <div ng-show="tc.displayMode == 'edit'">
        <!-- Dettaglio inizio -->
        <div class="page-toolbar">
            <button class="btn btn-grey" ng-click="tc.saveEdit(current)"><i class="fa fa-floppy-o">&nbsp;</i>Salva</button>
            <button class="btn btn-grey" ng-click="tc.cancelEdit()"><i class="fa fa-times">&nbsp;</i>Annulla</button>
        </div> <!-- page-toolbar -->
        <div class="margin-b-20"></div>
    </div> <!-- Dettaglio fine -->
</div>
